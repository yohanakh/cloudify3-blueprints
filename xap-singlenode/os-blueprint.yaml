tosca_definitions_version: cloudify_dsl_1_0

#######
# Cloudify Blueprint which describes a xap cluster (single node)
#
imports:
    - http://www.getcloudify.org/spec/cloudify/3.1/types.yaml
    - http://www.getcloudify.org/spec/diamond-plugin/1.1/plugin.yaml
    - http://www.getcloudify.org/spec/openstack-plugin/1.1/plugin.yaml


plugins:
    xap_config_plugin:
        executor: host_agent
        source: xap-config-plugin

    xap_admin_plugin:
        executor: host_agent
        source: xap-admin-plugin

workflows:
    deploy_grid:
        mapping: workflows/deploy_grid.py
        parameters:
            grid_name:
              default: dataGrid
            schema:
              default: partitioned-sync2backup
            partitions:
              default: 1
            backups:
              default: 0
            max_per_vm:
              default: 0
            max_per_machine:
              default: 0
    undeploy_grid:
        mapping: workflows/undeploy_grid.py
        parameters:
            grid_name:
              default: dataGrid
    deploy_pu:
        mapping: workflows/deploy_pu.py
        parameters:
            pu_url:
              default: ""
            override_pu_name:
              default: ""
            schema:
              default: partitioned-sync2backup
            partitions:
              default: 1
            backups:
              default: 0
            max_per_vm:
              default: 0
            max_per_machine:
              default: 0
    auto_heal_workflow:
        mapping: default_workflows.cloudify.plugins.workflows.auto_heal_reinstall_node_subgraph
        parameters:
            node_id:
              description: none

node_types:
    vm_host:
        derived_from: cloudify.openstack.nodes.Server
        properties:
            cloudify_agent:
              default:
                user: "ubuntu"

    xap.monitoredServer:
        derived_from: cloudify.nodes.Compute
        interfaces:
          cloudify.interfaces.monitoring_agent:
              install:
                implementation: diamond.diamond_agent.tasks.install
                inputs:
                  diamond_config:
                    default:
                      interval: 1
              start: diamond.diamond_agent.tasks.start
              stop: diamond.diamond_agent.tasks.stop
              uninstall: diamond.diamond_agent.tasks.uninstall

          cloudify.interfaces.monitoring:
              start:
                implementation: diamond.diamond_agent.tasks.add_collectors
                inputs:
                  collectors_config:
                    default:
                      CPUCollector: {}
                      MemoryCollector: {}
                      LoadAverageCollector: {}
                      DiskUsageCollector:
                        config:
                          devices: x?vd[a-z]+[0-9]*$
                      NetworkCollector: {}

    xap_type:
        derived_from: cloudify.nodes.ApplicationServer
        properties:
            GSA_JAVA_OPTIONS:
                type: string
                default: ''
            gsm_cnt:
                type: integer
                default: 0
            global_gsm_cnt:
                type: integer
                default: 0
            GSM_JAVA_OPTIONS:
                type: string
                default: ''
            lus_cnt:
                type: integer
                default: 0
            lus_port:
                type: integer
                default: 0
            LUS_JAVA_OPTIONS:
                type: string
                default: ''
            global_lus_cnt:
                type: integer
                default: 0
            gsc_cnt:
                type: integer
                default: 0
            GSC_JAVA_OPTIONS:
                type: string
                default: ''
            download_url:
                type: string
                default: http://gigaspaces-repository-eu.s3.amazonaws.com/com/gigaspaces/xap-core/10.1.0-SNAPSHOT/gigaspaces-xap-premium-10.1.0-m4-b12584-514.zip
            license_key:
                type: string
                default: ''
            lrmi_comm_min_port:
                type: integer
                default: 7122
            lrmi_comm_max_port:
                type: integer
                default: 7222

    xap_webui_type:
        derived_from: cloudify.nodes.WebServer
        properties:
            webui_port:
                type: integer
                default: 9099

    demo_shell_type:
        derived_from: cloudify.nodes.WebServer
        properties:
            port:
                type: integer
                default: 8080
            butterfly_repo:
                type: string
                default: https://github.com/CloudifySource/butterfly.git
            demo_url:
                type: string
                default: https://github.com/Gigaspaces/XAP-Interactive-Tutorial/archive/master.zip
            lrmi_comm_min_port:
                type: integer
                default: 7122
            lrmi_comm_max_port:
                type: integer
                default: 7222


relationships:
    xap_connected_to_lus:
        derived_from: cloudify.relationships.connected_to
        source_interfaces:
            cloudify.interfaces.relationship_lifecycle:
                postconfigure:
                    implementation: xap-scripts/get_locators.py
                    inputs: {}
     
node_templates:
        xap_management_security_group:
            type: cloudify.openstack.nodes.SecurityGroup
            properties:
                security_group:
                    name: xap_management_security_group
                rules:
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 8099
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 9099
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104

        xap_container_security_group:
            type: cloudify.openstack.nodes.SecurityGroup
            properties:
                security_group:
                    name: xap_container_security_group
                rules:
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104

        xap_management_vm:
            type: vm_host
            instances:
                deploy: 1
            properties:
              server:
                  image: "d81ccdfe-7482-460e-a7ce-69ea29aa129b"
                  flavor: "ba4e08fd-e4c5-4233-a906-f1bb31cb659d"
                  security_groups: ['xap_management_security_group']
            relationships:
                - target: floatingip
                  type: cloudify.openstack.server_connected_to_floating_ip
                - target: xap_management_security_group
                  type: cloudify.relationships.depends_on

        floatingip:
            type: cloudify.openstack.nodes.FloatingIP

        xap_container_vm:
            type: vm_host
            instances:
                deploy: 1
            properties:
              server:
                  image: "d81ccdfe-7482-460e-a7ce-69ea29aa129b"
                  flavor: "ba4e08fd-e4c5-4233-a906-f1bb31cb659d"
                  security_groups: ['xap_container_security_group']
            relationships:
                - target: xap_container_security_group
                  type: cloudify.relationships.depends_on

        xap_management:
            type: xap_type
            properties:
                lus_cnt: 1
                global_lus_cnt: 0
                gsm_cnt: 1
                global_gsm_cnt: 0
                gsc_cnt: 0
                GSM_JAVA_OPTIONS: -Xms128m -Xmx128m
            relationships:
                -   target: xap_management_vm
                    type: cloudify.relationships.contained_in
            interfaces:
                admin.commands:
                  deploy_grid:
                      implementation: xap_admin_plugin.xap_admin_plugin.tasks.deploy_grid
                      inputs:
                          script: xap-scripts/deploy-grid.sh
                  undeploy_grid:
                      implementation: xap_admin_plugin.xap_admin_plugin.tasks.undeploy_grid
                      inputs:
                          script: xap-scripts/undeploy-grid.sh
                  deploy_pu:
                      implementation: xap_admin_plugin.xap_admin_plugin.tasks.deploy_pu
                      inputs:
                          script: xap-scripts/deploy-pu.sh

                cloudify.interfaces.lifecycle:
                  create: xap-scripts/install-xap.sh
                  start: xap-scripts/start-xap.sh
                  stop: xap-scripts/stop-xap.sh


        xap_container:
            type: xap_type
            properties:
                gsc_cnt: 1
                GSC_JAVA_OPTIONS: -Xms128m -Xmx128m
            relationships:
                -   target: xap_container_vm
                    type: cloudify.relationships.contained_in
                -   target: xap_management
                    type: xap_connected_to_lus
            interfaces:
                cloudify.interfaces.lifecycle:
                  create: xap-scripts/install-xap.sh
                  start: xap-scripts/start-xap.sh
                  stop: xap-scripts/stop-xap.sh

        webui:
            type: xap_webui_type
            interfaces:
                cloudify.interfaces.lifecycle:
                  start: xap-scripts/start-ui.sh
                  stop: xap-scripts/stop-ui.sh
            relationships:
                - target: xap_management_vm
                  type: cloudify.relationships.contained_in
                - target: xap_management
                  type: cloudify.relationships.depends_on

        demo_shell:
            type: demo_shell_type
            interfaces:
                cloudify.interfaces.lifecycle:
                  create: butterfly-scripts/install.sh
                  start: butterfly-scripts/start.sh
            relationships:
                - target: xap_management_vm
                  type: cloudify.relationships.contained_in
                - target: xap_management
                  type: cloudify.relationships.depends_on


groups:

    autohealing_group':
      members: [xap_management_vm,xap_container_vm,webui]
      policies:
        simple_autoheal_policy:
          type: cloudify.policies.types.host_failure
          triggers:
            auto_heal_trigger:
              type:
                cloudify.policies.triggers.execute_workflow
              parameters:
                workflow: auto_heal_workflow
                allow_custom_parameters: True
                workflow_parameters:
                  node_id:
                    get_property: ['SELF', 'failing_node']
                  diagnose_value:
                    get_property: ['SELF', 'diagnose']

outputs:

    management_ui:
      description: XAP UI URL
      value:
        ip: {  get_attribute: [ xap_management_vm,  ip_address ] }
        port: 7104

